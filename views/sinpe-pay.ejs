<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago SINPE Móvil</title>
    <link href="/css/global.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="/css/checkout.css" />
    <link href="/css/sinpe-pay.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <header class="header-filler">
        <div class="checkout-header">
            <a href="/" class="checkout-brand">
                <img class="logo-img" src="/images/logo.png" alt="logo">
            </a>

            <nav class="checkout-steps">
                <div class="step">
                    <span class="step-index2">1</span>
                    <span class="step-label">Entrega</span>
                </div>

                <div class="step active">
                    <span class="step-index">2</span>
                    <span class="step-label">Pago</span>
                </div>

                <div class="step">
                    <span class="step-index2">3</span>
                    <span class="step-label">Confirmación</span>
                </div>
            </nav>
        </div>
    </header>

    <div class="page-wrapper">
        <h1 class="page-title">Pedido recibido</h1>

        <!-- ===== ORDER SUMMARY ===== -->
        <div class="order-summary">
            <p><strong>Número de pedido:</strong>
                <%= order.order_number || order.id %>
            </p>
            <p><strong>Fecha:</strong>
                <%= new Date(order.created_at).toLocaleDateString('es-CR', { year: 'numeric' , month: 'long' ,
                    day: 'numeric' }) %>
            </p>
            <p><strong>Total:</strong> ₡<%= order.total.toLocaleString("es-CR") %>
            </p>
            <p><strong>Método de pago:</strong>
                <%= order.payment_method==='sinpe' ? 'SINPE / Transferencia' : 'Tarjeta' %>
            </p>
            <p>Usa el número de pedido como referencia de tu pago y envía el comprobante por Whatsapp al 8792-5172</p>
        </div>

        <h2 class="section-title">Nuestros detalles bancarios</h2>
        <p class="bank-detail bank-account">SINPE 8792-5172</p>
        <p class="bank-detail bank-number">Cuenta IBAN BN: CR02015100320010439147</p>
        <p class="bank-detail bank-iban">Carmen Medina Puerta</p>

        <h2 class="section-title">Detalles del pedido</h2>
        <table class="order-table">
            <thead>
                <tr class="order-table-header">
                    <th>Producto</th>
                    <th>Detalle</th>
                    <th>Precio</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <% orderItems.forEach(item=> { %>
                    <tr class="order-product-row">
                        <td class="product-name">
                            <%= item.product_name %>
                        </td>
                        <td class="product-meta">
                            <%= item.size ? "Talla: " + item.size : "" %> × <%= item.quantity %>
                        </td>
                        <td class="product-unit-price">₡<%= Number(item.price).toLocaleString("es-CR") %>
                        </td>
                        <td class="product-total-price">₡<%= Number(item.price * item.quantity).toLocaleString("es-CR")
                                %>
                        </td>
                    </tr>
                    <% }) %>
                        <tr class="order-total-row">
                            <td colspan="3">Subtotal:</td>
                            <td>₡<%= Number(order.subtotal).toLocaleString("es-CR") %>
                            </td>
                        </tr>
                        <tr class="order-total-row">
                            <td colspan="3">Envío:</td>
                            <td>₡<%= Number(order.shipping).toLocaleString("es-CR") %>
                            </td>
                        </tr>
                        <tr class="order-total-row">
                            <td colspan="3">Total:</td>
                            <td>₡<%= Number(order.total).toLocaleString("es-CR") %>
                            </td>
                        </tr>
                        <tr class="order-total-row">
                            <td colspan="3">Método de pago:</td>
                            <td>SINPE o Transferencia Bancaria</td>
                        </tr>
            </tbody>
        </table>

        <p class="payment-reminder">Recuerda enviar tu comprobante de pago por Whatsapp al 87925172 indicando tu número
            de pedido.</p>

        <button id="btn-sinpe-confirm" class="link-confirm-payment" data-order-id="<%= order.id %>"
            data-order-number="<%= order.order_number || order.id %>" data-total="<%= order.total %>"
            data-created-at="<%= order.created_at %>" disabled>
            He enviado el pago
        </button>

        <div class="pending-msg">
            Tu pago SINPE está en proceso de verificación. El botón <strong>“He enviado el pago”</strong> se habilitará
            automáticamente una vez que confirmemos el comprobante.
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("btn-sinpe-confirm");

            if (!btn) return;

            btn.addEventListener("click", () => {
                const orderData = {
                    orderId: btn.dataset.orderId,
                    orderNumber: btn.dataset.orderNumber,
                    total: Number(btn.dataset.total),
                    paymentMethod: "SINPE Móvil",
                    createdAt: btn.dataset.createdAt,
                };

                sessionStorage.setItem(
                    "order_completed",
                    JSON.stringify(orderData)
                );

                window.location.href = "/confirm";
            });
        });
    </script>

    <script>
        window.SINPE_ORDER_ID = "<%= order.id %>";
    </script>

    <script src="/js/sinpe-pay.js"></script>
</body>

</html>